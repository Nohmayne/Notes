# Error Handling

*OpenGL is pretty bad at handling errors on it's own. Let's fix that!*

## Table of Contents

1.  Overview
2.  Clearing the Errors
3.  Printing the Errors
4.  Assertions
    1.  Basics
    2.  Making a complete wrapper
    3.  Getting better output
5.  Conclusion
    1.  Resources

## Overview

When a OpenGL function is called and it doesn't have the right data, or a buffer isn't set up correctly, OpenGL just closes the window or draws a black screen instead of actually showing the error. OpenGL does provide a function, `glGetError()` to fix this. This function allows us to get OpenGL to tell us the error. The typical workflow is as follows:

1.  Clear all the OpenGL errors
2.  Call the OpenGL function
3.  Get any new errors generated by the function call

This is a very common method because it's completely backwards compatible. There is another method that's only available in OpenGL 4.0+, which is much better, but for now (for compatibility) we'll use `glGetError()`.

>   View `glGetError()` on [docs.gl](http://docs.gl/gl4/glGetError)

## Clearing the Errors

The `glGetError()` function is used for both getting and clearing errors. This function should also be called in a loop to ensure all errors are received.

Let's write a function to clear all errors. In order to clear the errors, we need to call `glGetError()` until there are no more errors to get, at which point we will be working from a clean slate. Since we know `glGetError()` returns `GL_NO_ERROR` when there isn't any error, we can use that to call `glGetError()` until there are no more errors.

```c++
static void GLClearError()
{
    while (glGetError() != GL_NO_ERROR);
}
```

Now when our function is called, all of the current OpenGL errors will be cleared.

## Printing the Errors

This function will behave very similarly to our `GLClearError()` function. Instead of ignoring the output, however, we'll actually print it to the console. To do this, we'll store the result of `glGetError()` in a variable and print that to the console (`#include <stdio.h>` or `<iostream>` for this).

```c++
static void GLCheckError()
{
    while (GLenum err = glGetError())
    {
        fprintf(stderr, "[OpenGL-->Err] (%s)\n", error);
    }
}
```

Now, if we want to check for an error in an OpenGL function call, we can surround our function with `GLClearError()` and `GLCheckError()`. This is sub-optimal because it pollutes the code and is repetitive, as well as inefficient. In addition, the `GLCheckError()` function only outputs an error code, which is not very helpful.

To help remedy this, we can use assertions.

## Assertions

### Basics

Assertions are essentially breakpoints made through code. This means that when an asserted function throws an error, the program stops execution at that line. Let's modify our `GLCheckError()` function to return a boolean, and we'll also rename it to `GLLogCall()`.

```c++
static bool GLLogCall()
{
    while (GLenum err = glGetError())
    {
        fprintf(stderr, "[OpenGL-->Err] (%s)\n", error);
        return false;
    }
    return true;
}
```

Now we'll define our `ASSERT()` macro at the top of our file, right below the `#include` statements. This macro will behave as described above, so we need to check if a given input is false, and if it is, we'll raise an interrupt signal to be interpreted by our debugger. To be able to raise a `SIGINT`, be sure to `#include <csignal>`

```c++
#define ASSERT(x) if (!(x)) std::raise(SIGINT);
```

This `#define` is basically saying that if the value `x` passed into the `ASSERT()` statement is false, then `raise(SIGINT)`. This means we'll get an interrupt signal on the specific line that's causing the issue, provided we `ASSERT(GLLogCall());`.

### Making a complete wrapper

While we now have better debugging than before, we still have to call `GLClearError()` before the function and our assertion statement after. This is still too messy. Instead, we'll use another macro to put the whole thing in one line. This will look very similar to our `ASSERT(x)` macro.

```c++
#define GLCall(x) GLClearError();\
	x;\
	ASSERT(GLLogCall())
```

>   The backslashes here are simply to split up the lines.
>
>   Also, we don't need an ending ';' character because we'll be following this function with one anyways.

Here we essentially perform all the actions we wanted to do in the first place, but in one line:

1.  Clear all the OpenGL errors &rightarrow; `GLClearError();`
2.  Call the OpenGL function &rightarrow; `x;`
3.  Get any new errors generated by the function call &rightarrow; `ASSERT(GLLogCall())`

Now, we can wrap any OpenGL function in this macro, and it will automatically search for errors caused by that function.

```c++
GLCall(glDrawElements(GL_TRIANGLES, 6, GL_UNSIGNED_INT, nullptr));
```

We still don't have the error message specifying which file or line the error is on, which is not the best. Let's fix that now.

### Getting better output

To print the actual function, file, and line where the error occurred, let's add some arguments to our `GLLogCall()` function and modify it to print their values.

```c++
static bool GLLogCall(const char* function, const char* file, int line)

{
    while (GLenum err = glGetError())
    {
        fprintf(stderr, "[OpenGL-->Err] (%s): %s %s: %s\n", error, function, file, line);
        return false;
    }
    return true;
}
```

Now we need to fill all that information in. The function name can be retrieved by doing `#x` in our assertion, which returns the string value of `x`. The file can be found by using `__FILE__`, which is *not* intrinsic and thus should work universally. Finally, the line can be found by using `__LINE__`, the same way we use `__FILE__`. Our final assert statement in our `GLCall()` macro should look like this:

```c++
ASSERT(GLLogCall(#x, __FILE__, __LINE__))
```

## Conclusion

Now we have a function we can call to get extensive errors, but we still have to wrap every single OpenGL function in our program with it. This is still not the best, so we will be migrating to a more modern method in the future.

### Resources

-   [docs.gl](http://docs.gl/)
-   [StackOverflow](https://stackoverflow.com/questions/4326414/set-breakpoint-in-c-or-c-code-programmatically-for-gdb-on-linux)
-   [The Cherno](https://www.youtube.com/watch?v=FBbPWSOQ0-w&list=PLlrATfBNZ98foTJPJ_Ev03o2oq3-GGOS2&index=11&t=0s)
    -   Support his [patreon](https://patreon.com/thecherno)